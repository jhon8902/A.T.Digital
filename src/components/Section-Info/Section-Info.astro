---
// --- CARGA Y FILTRO DE NOTAS DE CATEGORÍA "noticias" ---

let dynamicNotes: any[] = [];

try {
  // 1️⃣ Traemos las notas desde tu función de Netlify
  const baseUrl = import.meta.env.DEV
    ? "http://localhost:8888"
    : Astro.site || "";
  const res = await fetch(`${baseUrl}/.netlify/functions/get-notes`);

  if (res.ok) {
    const data = await res.json();

    // 2️⃣ Filtramos solo las notas de la categoría "noticias"
    const filtered = data.filter(
      (note: any) => note.category?.toLowerCase() === "noticias"
    );

    // 3️⃣ Normalizamos formato para el carrusel
    dynamicNotes = filtered.map((note: any) => ({
      href: `/notas/${note.id}`,
      img: note.image1 || "/img/default.jpg",
      alt: note.title,
      caption: note.title,
      fecha: `Publicado: ${new Date(note.created_at).toLocaleDateString("es-CO")}`,
    }));
  } else {
    console.error("❌ Error al obtener notas:", res.statusText);
  }
} catch (err) {
  console.error("❌ Error cargando notas dinámicas:", err);
}

// 4️⃣ Notas estáticas (las que ya tenías)
const staticNotes = [
  {
    href: "/noticias-carrusel/noticia-ford",
    img: "/img/ford-bronco/ford-bronco-portada.jpg",
    alt: "Ford Bronco, SUV todo terreno",
    caption: "Ford Bronco: la última apuesta todoterreno.",
    fecha: "Publicado: 01/07/2025",
  },
  {
    href: "/noticias-carrusel/noticia-audi",
    img: "/img/audi-etron/audi-portada.webp",
    alt: "Audi E-TRON: SUV eléctrico de lujo",
    caption: "Audi E-TRON: el SUV eléctrico más elegante de la marca.",
    fecha: "Publicado: 28/06/2025",
  },
  {
    href: "/noticias-carrusel/noticia-bmw-concept",
    img: "/img/bmw-concept/bmw-concept-portada.webp",
    alt: "BMW Concept XM",
    caption: "BMW Concept XM: El Futuro del Lujo y la Potencia Híbrida",
    fecha: "Publicado: 25/06/2025",
  },
  {
    href: "/noticias-carrusel/noticia-bmw",
    img: "/img/bmw-330e/bmw.webp",
    alt: "BMW Serie 5 eléctrico y potente",
    caption: "BMW Serie 5: poderoso y ahora electrificado.",
    fecha: "Publicado: 20/06/2025",
  },
  {
    href: "/noticias-carrusel/noticia-dfsk",
    img: "/img/dfsk-e5/dfsk-ultima-portada.jpg",
    alt: "DFSK E5: híbrida para 7 pasajeros",
    caption: "DFSK seres e5: la híbrida para 7 pasajeros en Colombia.",
    fecha: "Publicado: 15/06/2025",
  },
];

// 5️⃣ Combinamos dinámicas + estáticas y mostramos máximo 5
const allNotes = [...dynamicNotes, ...staticNotes].slice(0, 5);
---

<section id="noticias" class="section-info w-full py-30">
  <div class="info-header">
    <h1 class="info-titulo anim-titulo">
      Noticias sobre ruedas
      <span class="icono-rueda">
        <i class="fa-solid fa-gauge-high"></i>
      </span>
    </h1>
    <p class="info-descripcion">
      La actualidad del sector automotor colombiano: lanzamientos, regulaciones,
      tecnología y más.
    </p>
  </div>

  <div class="container mx-auto px-2">
    <div id="carousel" class="relative flex overflow-hidden">
      {
        allNotes.map((nota) => (
          <a
            href={nota.href}
            class="carousel-item relative w-full transition-opacity duration-[1400ms] hover:opacity-75"
          >
            <img
              src={nota.img}
              alt={nota.alt}
              class="w-full h-full object-cover"
            />
            <div class="carousel-caption">
              {nota.caption}
              <span class="fecha-publicacion">{nota.fecha}</span>
            </div>
          </a>
        ))
      }
    </div>

    <!-- Botones de navegación -->
    <button id="prevBtn" class="carousel-control-prev" aria-label="Anterior"
      >❮</button
    >
    <button id="nextBtn" class="carousel-control-next" aria-label="Siguiente"
      >❯</button
    >

    <!-- Botón Ver más noticias -->
    <div class="ver-mas-noticias-section">
      <a href="/noticias" class="ver-mas-noticias-btn">Ver más noticias</a>
    </div>
  </div>
</section>

<style>
  html {
    scroll-behavior: smooth;
    scroll-margin-top: 100px; /* ajusta según el alto de tu menú sticky */
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  .container {
    width: 100%; /* Asegura que ocupe todo el ancho */
    max-width: 100%; /* Evita restricciones de ancho */
    margin: 0 auto; /* Centra el contenido */
    padding: 0; /* Elimina padding innecesario */
    font-family: "Georgia", serif;
  }

  .section-info {
    background: black;
  }

  @keyframes fadeInTitle {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeIn {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .info-header {
    background: linear-gradient(90deg, #fbcb1d 86%, #232323 76%);
    padding: 38px 0 24px 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 18px; /* Espacio uniforme entre todos los hijos */
  }

  .info-titulo {
    color: black;
    font-size: 90px;
    letter-spacing: 2px;
    font-family: "Georgia", serif;
    text-transform: uppercase;
    font-weight: 800;
    text-shadow: none;
    padding: 0;
    opacity: 1;
    background: none;
    margin: 0;
  }

  .info-descripcion {
    color: rgb(16, 16, 16);

    font-size: 1.9rem;
    font-weight: 600;
    text-align: center;
    background: none;
    max-width: 1000px;
    line-height: 1.4;
    margin: 0;
    padding: 0;
  }

  @media (max-width: 600px) {
    .info-header {
      padding: 18px 0 10px 0;
    }
    .info-icono {
      font-size: 1.7rem;
      margin-bottom: 10px;
    }
    .info-titulo {
      font-size: 28px;
      margin-bottom: 8px;
      text-align: center;
    }
    .info-descripcion {
      color: #2b2502;
      max-width: 80%; /* o 85%, según se vea mejor */
      text-align: start;
      font-size: 1rem;
      padding: 0 8px;
      /* text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.6);  mejora legibilidad */
    }
    .info-header {
      background: linear-gradient(120deg, #fbcb1d 75%, #232323 65%);
    }
  }

  .icono-rueda {
    color: #f6f5f3; /* Amarillo de tu paleta */
    font-size: 1.4em;
    margin-left: 18px;
    filter: drop-shadow(0 2px 4px #0008);
    display: inline-flex;
    align-items: center;
  }

  .descripcion-noticias {
    font-size: 2rem;
    text-align: center;
    color: rgb(9, 31, 75);
    padding: 20px;
    font-family: "Georgia", serif;
    margin-top: -25px;
    font-weight: 600;

    opacity: 0;
    transform: translateY(20px);
    animation: fadeIn 1.5s ease-out forwards;
    animation-delay: 0.3s; /* Para que aparezca justo después del h1 */
  }

  #carousel {
    position: relative;
    width: 100%; /* Asegura que ocupe todo el ancho */
    height: 100vh;
    overflow: hidden;
    margin: 0 auto; /* Centra el carrusel si hay espacio adicional */
    padding: 0;
    border-bottom: none;
  }

  .carousel-item {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    opacity: 0;
    transition: opacity 1s ease-in-out;
    z-index: 0;
  }

  .carousel-item.active {
    opacity: 1;
    z-index: 1;
  }

  .carousel-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform 2.9s ease;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9);
    background: rgba(0, 0, 0, 0.8);
  }

  .carousel-item:hover img {
    transform: scale(1.1) translateY(-10px);
  }

  /* Agrega este bloque al final de tu <style> */
  .fecha-publicacion {
    display: block;
    font-size: 0.5em;
    color: #dbad06;
    margin-top: 6px;
    font-weight: 300;
    letter-spacing: 0.5px;
  }

  .sticky-container {
    position: relative;
  }

  .sticky-titulo {
    position: relative;
    top: 0;
    z-index: 100;
  }

  /* Carrusel: caption con degradado */
  .carousel-caption {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    background: linear-gradient(
      180deg,
      rgba(20, 14, 1, 0) 0%,
      rgba(20, 14, 1, 0.85) 100%
    );
    color: #fff;
    font-size: 2.6rem;
    padding: 18px 40px 12px 40px;
    font-weight: 600;
    text-align: center;
    z-index: 5;
    border: none;
    box-shadow: none;
    opacity: 0;
    pointer-events: none;
    text-transform: uppercase;
  }

  .carousel-item.active .carousel-caption {
    opacity: 1;
    animation: captionFade 2.6s ease forwards;
    pointer-events: auto;
  }
  @keyframes captionFade {
    0% {
      opacity: 0;
      transform: translateY(20px) translateX(-50%);
    }
    100% {
      opacity: 1;
      transform: translateY(0) translateX(-50%);
    }
  }

  .carousel-item a {
    display: flex;
    position: absolute;
    text-align: center;
    margin: 25px auto;
    background-color: #19354b;
    color: white;
    font-size: 1.25rem;
    border-radius: 10px;
    text-decoration: none;
    transition: transform 0.3s ease;
    bottom: -25px;
    width: auto;
    max-width: fit-content;
    padding: 8px 24px;
  }

  .carousel-item a:hover {
    transform: scale(1.07);
    background-color: rgb(154, 117, 8);
    color: white;
    transition: background-color 0.6s ease;
  }

  /* Centrar botones prev/next sobre la imagen */
  .carousel-control-prev,
  .carousel-control-next {
    position: absolute;
    top: 130%;
    transform: translateY(-50%);
    background-color: white;
    color: black;
    border: none;
    font-size: 45px;
    cursor: pointer;
    z-index: 10;
    border-radius: 50%;
    padding: 12px;
    width: 58px;
    height: 68px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    transition:
      background-color 0.3s ease,
      color 0.3s ease,
      transform 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .carousel-control-prev {
    left: 15px;
  }

  .carousel-control-next {
    right: 15px;
  }

  .carousel-control-prev:hover,
  .carousel-control-next:hover {
    background-color: white;
    color: rgb(20, 55, 81);
    transform: translateY(-50%) scale(1.15);
  }

  .ver-mas-noticias-section {
    display: flex;
    justify-content: center;
    margin: 30px 0 0 0;
  }
  .ver-mas-noticias-btn {
    background: #f8ca26;
    color: #181818;
    font-size: 22px;
    margin-bottom: 40px;
    font-weight: 600;
    border: none;
    border-radius: 50px;
    padding: 14px 36px;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    text-decoration: none;
    transition: background 0.2s;
  }
  .ver-mas-noticias-btn:hover {
    background: #e9c02d;
    color: #000;
  }

  /* animacion titulo pricipal h1*/
  .anim-titulo {
    opacity: 0;
    transform: translateY(-40px);
    animation: none;
  }

  .anim-titulo.visible {
    animation: fadeInTitle 1.2s forwards;
  }

  @keyframes fadeInTitle {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 768px) {
    #noticias {
      scroll-margin-top: 100px !important; /* móvil, ajusta según el alto del menú hamburguesa */
    }

    h1 {
      font-size: 1.6rem;
    }

    .carousel-caption {
      font-size: 1.6rem;
      padding: 8px;
    }

    .carousel-item a {
      padding: 6px 20px;
      font-size: 1rem;
    }

    #carousel,
    .carousel-item {
      height: 60vh;
    }

    .carousel-item img {
      height: 60vh;
    }

    .carousel-control-prev,
    .carousel-control-next {
      top: 70%;
      width: 50px;
      height: 58px;
      font-size: 32px;
    }

    .carousel-control-prev {
      left: 10px;
    }

    .carousel-control-next {
      right: 10px;
    }
  }

  @media (max-width: 480px) {
    h1 {
      font-size: 1.6rem;
      padding-top: 20px;
      letter-spacing: 1px;

      position: relative; /* necesario para posicionar el pseudo-elemento */
    }

    .descripcion-noticias {
      font-size: 1rem;
      padding: 10px;
      margin-top: 0; /* Ajusta el margen superior */
      text-align: center;
      margin-bottom: 15px; /* Más aire en móviles */
    }

    p {
      background-color: none;
    }

    .ford,
    .mazda,
    .bmw,
    .audi,
    .byd {
      font-size: 1.25rem;
    }

    .carousel-caption {
      font-size: 1.2rem;
      padding: 10px;
      text-transform: none;
      top: auto;
    }

    .carousel-item a {
      padding: 10px 20px;
      font-size: 1rem;
    }

    /* altura contenedor imagenes carrusel */
    #carousel,
    .carousel-item {
      height: 48vh;
    }

    /* altura imagenes */
    .carousel-item img {
      height: 34vh;
    }

    .carousel-control-prev,
    .carousel-control-next {
      width: 34px;
      height: 40px;
      top: 67%;
      font-size: 26px;
      color: black;
      background-color: white;
      text-transform: uppercase;
    }

    .carousel-control-prev {
      left: 15px;
    }

    .carousel-control-next {
      right: 15px;
    }

    .fecha-publicacion {
      font-size: 0.6em;
      color: #dbad06;
      margin-top: 4px;
      font-weight: 300;
      letter-spacing: 0.5px;
    }

    .ver-mas-noticias-btn {
      font-size: 12px;

      padding: 10px 24px;
    }
  }

  #noticias {
    scroll-margin-top: 120px; /* Ajusta este valor al alto real de tu menú */
  }
</style>

<script>
  window.addEventListener("DOMContentLoaded", () => {
    const titulo = document.querySelector(".anim-titulo");
    const seccion = document.getElementById("noticias");
    if (titulo && seccion) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              titulo.classList.remove("visible");
              // Forzar reflujo para reiniciar animación
              void (titulo as HTMLElement).offsetWidth;
              titulo.classList.add("visible");
            }
          });
        },
        { threshold: 0.3 } // Ajusta el umbral según necesites
      );
      observer.observe(seccion);

      // 👇 Fuerza la animación si ya está visible al cargar
      if (seccion.getBoundingClientRect().top < window.innerHeight) {
        titulo.classList.add("visible");
      }
    }

    const carousel = document.getElementById("carousel");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    if (carousel && prevBtn && nextBtn) {
      const items = Array.from(
        carousel.getElementsByClassName("carousel-item")
      );
      let currentIndex = 0;
      let autoInterval: any = null;
      const AUTO_TIME = 5000; // 5 segundos

      function showItem(index: number) {
        items.forEach((item, i) => {
          item.classList.remove("active");
          const caption = item.querySelector(".carousel-caption");
          if (caption) {
            (caption as HTMLElement).classList.remove("animate-caption");
            void (caption as HTMLElement).offsetWidth;
            (caption as HTMLElement).classList.add("animate-caption");
          }
          const button = item.querySelector("a");
          if (button) {
            (button as HTMLElement).classList.remove("animate-caption");
            void (button as HTMLElement).offsetWidth;
            (button as HTMLElement).classList.add("animate-caption");
          }
        });
        items[index].classList.add("active");
      }

      function nextItem() {
        currentIndex = (currentIndex + 1) % items.length;
        showItem(currentIndex);
      }

      function prevItem() {
        currentIndex = (currentIndex - 1 + items.length) % items.length;
        showItem(currentIndex);
      }

      function startAuto() {
        if (autoInterval) clearInterval(autoInterval);
        autoInterval = setInterval(nextItem, AUTO_TIME);
      }

      prevBtn.addEventListener("click", () => {
        prevItem();
        startAuto(); // Reinicia el temporizador al navegar manualmente
      });

      nextBtn.addEventListener("click", () => {
        nextItem();
        startAuto();
      });

      showItem(currentIndex);
      startAuto();
    }
  });
</script>
